# ============================================================================
# This code contains proprietary source code from NEHONIX
# Copyright Â© 2025 NEHONIX - www.nehonix.com
# Licensed under NEHONIX Open Source License (NOSL) v1.0
# ============================================================================
# XyNginC - Non-SSL Virtual Host Configuration Template
# ============================================================================
# HTTP configuration for domains without SSL/TLS encryption
# Optimized for security, performance, and reliability
#
# Usage:
#   Replace template variables while running the script:
#   - {{DOMAIN_NAME}}     : Your domain (e.g., example.com)
#   - {{BACKEND_HOST}}    : Backend server hostname/IP (e.g., localhost, 127.0.0.1)
#   - {{BACKEND_PORT}}    : Backend application port (e.g., 3000, 8080)
#   - {{MAX_BODY_SIZE}}   : Maximum upload size (e.g., 10M, 50M, 100M)
#
# Requirements:
#   - nginx-module-headers-more for custom Server header manipulation
#   - Install: sudo apt install nginx-module-headers-more
#   - Load in main nginx.conf: load_module modules/ngx_http_headers_more_filter_module.so;
#
# Version: 2.0
# Last Updated: 2025-01-18
# ============================================================================

# ============================================================================
# HTTP Virtual Host Configuration
# ============================================================================

server {
    # Listen on standard HTTP port for both IPv4 and IPv6
    listen 80;
    listen [::]:80;  # IPv6 support for modern networking
    
    # Server name - replace with actual domain
    server_name {{DOMAIN_NAME}};

    # ------------------------------------------------------------------------
    # Security Configuration
    # ------------------------------------------------------------------------

    # Hide nginx version number to prevent information disclosure
    # Attackers use version info to identify known vulnerabilities
    server_tokens off;

    # Custom Server header - replace nginx signature
    # Prevents automated scanners from identifying web server software
    more_clear_headers Server;
    more_set_headers "Server: NEHONIX/XNCP";
    
    # Security headers to protect against common web vulnerabilities
    # X-Frame-Options: Prevents clickjacking attacks by disabling iframe embedding
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # X-Content-Type-Options: Prevents MIME-type sniffing attacks
    add_header X-Content-Type-Options "nosniff" always;
    
    # X-XSS-Protection: Enables browser's built-in XSS filter (legacy browsers)
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Referrer-Policy: Controls referrer information sent with requests
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # X-Permitted-Cross-Domain-Policies: Restricts cross-domain policy files
    add_header X-Permitted-Cross-Domain-Policies "none" always;

    # ------------------------------------------------------------------------
    # Client Request Limits
    # ------------------------------------------------------------------------

    # Maximum allowed size for client request body (file uploads)
    # Adjust based on application requirements (default: 10M)
    client_max_body_size {{MAX_BODY_SIZE}};
    
    # Buffer size for reading client request body
    # Larger buffers reduce disk I/O for typical requests
    client_body_buffer_size 128k;
    
    # Buffer size for reading client request headers
    client_header_buffer_size 1k;
    
    # Maximum number and size of buffers for large client headers
    # Useful for applications with many cookies or complex headers
    large_client_header_buffers 4 16k;

    # ------------------------------------------------------------------------
    # Logging Configuration
    # ------------------------------------------------------------------------

    # Access log - records all incoming requests with combined format
    # Includes: IP, timestamp, request, status, size, referrer, user-agent
    access_log /var/log/nginx/{{DOMAIN_NAME}}_access.log combined;
    
    # Error log - records server errors and warnings
    # Levels: debug, info, notice, warn, error, crit, alert, emerg
    error_log /var/log/nginx/{{DOMAIN_NAME}}_error.log warn;

    # ------------------------------------------------------------------------
    # Custom Error Pages Configuration
    # ------------------------------------------------------------------------

    # Proxy/upstream errors (502, 503, 504) - server-side issues
    # 502 Bad Gateway: Backend server returned invalid response
    # 503 Service Unavailable: Backend server is temporarily down
    # 504 Gateway Timeout: Backend server did not respond in time
    error_page 502 503 504 /error.html;

    # Client errors (404, 301) - handled by nginx for static files only
    # Backend application handles its own 404/301 responses
    error_page 404 /errors/404.html;
    error_page 301 /errors/301.html;

    # Error page handlers - serve custom HTML error pages
    # 'internal' directive ensures these are only accessible via error_page
    location = /errors/404.html {
        root /var/www/html;
        internal;
        default_type text/html;
    }

    location = /errors/301.html {
        root /var/www/html;
        internal;
        default_type text/html;
    }

    location = /error.html {
        root /var/www/html/errors;
        internal;
        default_type text/html;
    }

    # ------------------------------------------------------------------------
    # Static File Serving with Aggressive Caching
    # ------------------------------------------------------------------------

    # Serve common static assets directly from nginx (images, CSS, JS, fonts, videos)
    # This bypasses the backend application for better performance
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|mp4|webm|webp|avif)$ {
        root /var/www/html;
        
        # Return 404 if file doesn't exist locally (don't proxy to backend)
        try_files $uri =404;
        
        # Custom 404 page for missing static files
        error_page 404 /errors/404.html;
        
        # Cache static files for 30 days in browser
        # 'public' allows caching by CDNs and proxies
        # 'immutable' tells browsers the file will never change
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # Disable access logging for static files (reduces I/O)
        access_log off;
    }

    # ------------------------------------------------------------------------
    # Backend Application Proxy (Main Location)
    # ------------------------------------------------------------------------

    location / {
        # Forward all requests to backend application server
        proxy_pass http://{{BACKEND_HOST}}:{{BACKEND_PORT}};
        
        # Use HTTP/1.1 for better keepalive support
        proxy_http_version 1.1;
        
        # WebSocket support - upgrade HTTP connection when requested
        # Required for real-time applications (Socket.IO, WebRTC, SSE)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Standard proxy headers - preserve original request information
        # Host: Original hostname from client request
        proxy_set_header Host $host;
        
        # X-Real-IP: Original client IP address
        proxy_set_header X-Real-IP $remote_addr;
        
        # X-Forwarded-For: Chain of proxy IPs (for multiple proxies)
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # X-Forwarded-Proto: Original protocol (http/https)
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # X-Forwarded-Host: Original hostname
        proxy_set_header X-Forwarded-Host $server_name;
        
        # Proxy timeout settings - adjust based on application needs
        # Connect timeout: Time to establish connection with backend
        proxy_connect_timeout 90s;
        
        # Send timeout: Time to send request to backend
        proxy_send_timeout 90s;
        
        # Read timeout: Time to receive response from backend
        proxy_read_timeout 90s;
        
        # Proxy buffering settings for optimal performance
        # Buffering: Enable response buffering (improves performance)
        proxy_buffering on;
        
        # Buffer size: Size of buffer for reading response headers
        proxy_buffer_size 4k;
        
        # Buffers: Number and size of buffers for reading response
        proxy_buffers 8 4k;
        
        # Busy buffers: Maximum size of buffers that can be busy sending
        proxy_busy_buffers_size 8k;
        
        # CRITICAL: Do NOT intercept backend 4xx errors
        # Let backend application handle its own error responses (JSON APIs, etc.)
        proxy_intercept_errors off;
        
        # Retry logic for upstream failures
        # Only retry on: connection errors, timeouts, invalid headers, 502/503/504
        # Do NOT retry on: 404, 500 (these are valid application responses)
        proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
        
        # Maximum number of retry attempts
        proxy_next_upstream_tries 2;
    }

    # ------------------------------------------------------------------------
    # Health Check Endpoints
    # ------------------------------------------------------------------------

    # Nginx-level health check - returns 200 OK with JSON status
    # Use this for load balancer health checks
    location /xncp/health {
        # Disable logging for health checks (reduces noise)
        access_log off;
        
        # Return healthy status with timestamp
        return 200 '{"status":"healthy","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # Backend readiness check - proxies to application health endpoint
    # Use this to verify backend application is ready to serve traffic
    location /ready {
        access_log off;
        
        # Forward to backend application's readiness endpoint
        proxy_pass http://{{BACKEND_HOST}}:{{BACKEND_PORT}}/ready;
        
        # Short timeouts for quick health check response
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }

    # ------------------------------------------------------------------------
    # Security: Deny Access to Sensitive Files
    # ------------------------------------------------------------------------

    # Block access to hidden files and directories (starting with .)
    # Protects: .git, .env, .htaccess, .ssh, etc.
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
        return 404;
    }

    # Block access to backup and configuration files
    # Protects: database backups, config files, source files
    location ~* \.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist|env|git)$ {
        deny all;
        access_log off;
        log_not_found off;
        return 404;
    }

    # ------------------------------------------------------------------------
    # SEO and Bot Management
    # ------------------------------------------------------------------------

    # Serve robots.txt without logging (reduces noise)
    location = /robots.txt {
        access_log off;
        log_not_found off;
    }
    
    # Serve favicon.ico without logging (reduces noise)
    location = /favicon.ico {
        access_log off;
        log_not_found off;
    }
}

# ============================================================================
# Configuration Notes
# ============================================================================
# 1. This configuration is for HTTP-only (non-SSL) environments
# 2. For production use, consider using SSL template instead
# 3. Test configuration: nginx -t
# 4. Reload nginx: systemctl reload nginx
# 5. Monitor logs: tail -f /var/log/nginx/{{DOMAIN_NAME}}_error.log
# 6. Adjust timeouts based on application requirements
# 7. Review error logs regularly for security threats
# ============================================================================