##
# Default Server Configuration for Production
# Serves as a secure fallback for unmatched requests and direct IP access
# Best practices implementation following OWASP and nginx security guidelines
# Documentation: https://nginx.org/en/docs/http/request_processing.html
##

server {
    # Listen on standard HTTP ports for IPv4/IPv6 with default_server priority
    listen 80 default_server;
    listen [::]:80 default_server;

    # Catch-all server_name for unmatched domains/IP access
    server_name _;

    # Hide nginx version for security
    server_tokens off;

    # Security headers (OWASP recommended)
    # Reference: https://cheatsheetseries.owasp.org/cheatsheets/HTTP_Headers_Cheat_Sheet.html
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header X-Permitted-Cross-Domain-Policies "none" always;

    # Client request limits
    client_max_body_size 1M;
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 8k;

    # Rate limiting (requires zone definition in http block)
    # limit_req zone=default_limit burst=20 nodelay;
    # limit_conn addr 10;

    # Custom logging with detailed information
    access_log /var/log/nginx/default.access.log combined;
    error_log /var/log/nginx/default.error.log warn;

    # Global HTTPS redirect (uncomment if SSL is configured globally)
    # return 301 https://$host$request_uri;

    # Custom error pages for 4xx/5xx status codes
    error_page 400 401 403 404 /errors/error.html;
    error_page 500 502 503 504 /errors/error.html;
    
    location = /errors/error.html {
        root /var/www/html;
        internal;  # Prevent direct access via URL
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }

    # Main location block
    location / {
        root /var/www/html;
        index index.html index.htm;

        # Security: Block access to hidden files and directories
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
            return 404;
        }

        # Try files fallback: file -> directory -> named location
        try_files $uri $uri/ @not_found;
    }

    # Named location for 404 handling
    location @not_found {
        add_header Content-Type text/plain always;
        return 404 "404 - Resource Not Found\n\nThis server is not configured for the requested domain.\nPlease contact the system administrator.\n";
    }

    # Security: Deny access to backup and sensitive files
    location ~* \.(bak|backup|config|sql|fla|psd|ini|log|sh|inc|swp|dist|env|git|svn|htaccess|htpasswd)$ {
        deny all;
        access_log off;
        log_not_found off;
        return 404;
    }

    # Security: Block common exploit attempts
    location ~* (wp-admin|wp-login|xmlrpc\.php|wp-content) {
        deny all;
        access_log off;
        log_not_found off;
        return 404;
    }

    # Robots.txt handling (prevent indexing of default server)
    location = /robots.txt {
        add_header Content-Type text/plain;
        return 200 "User-agent: *\nDisallow: /\n";
        access_log off;
        log_not_found off;
    }

    # Favicon handling (prevent 404 errors in logs)
    location = /favicon.ico {
        access_log off;
        log_not_found off;
        return 204;  # No Content
    }

    # Static assets caching for performance (if serving static files)
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif)$ {
        root /var/www/html;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
        access_log off;
        log_not_found off;
        try_files $uri =404;
    }

    # Health check endpoint (useful for load balancers)
    location /health {
        access_log off;
        add_header Content-Type application/json;
        return 200 '{"status":"ok","server":"default","timestamp":"$time_iso8601"}';
    }
}

##
# Recommended additions to http {} block in /etc/nginx/nginx.conf:
#
# # Rate limiting zones
# limit_req_zone $binary_remote_addr zone=default_limit:10m rate=10r/s;
# limit_conn_zone $binary_remote_addr zone=addr:10m;
#
# # Connection limits
# limit_req_status 429;
# limit_conn_status 429;
#
# # Logging format with timing
# log_format detailed '$remote_addr - $remote_user [$time_local] '
#                     '"$request" $status $body_bytes_sent '
#                     '"$http_referer" "$http_user_agent" '
#                     'rt=$request_time uct="$upstream_connect_time" '
#                     'uht="$upstream_header_time" urt="$upstream_response_time"';
##

##
# Virtual Host Management:
# - Enable site: ln -s /etc/nginx/sites-available/mysite.conf /etc/nginx/sites-enabled/
# - Test config: nginx -t
# - Reload nginx: systemctl reload nginx
# - View logs: tail -f /var/log/nginx/default.access.log
# - Disable default server: rm /etc/nginx/sites-enabled/default
##