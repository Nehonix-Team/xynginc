# This configuration is managed by XyNginC and should not be edited manually

# ============================================================================
# XyNginC - Custom NGINX Main Configuration
# ============================================================================
# This configuration file replaces the default /etc/nginx/nginx.conf
# with security-hardened setup optimized for XyPriss applications
# 
# Key Features:
# - Performance optimizations for high-traffic applications
# - Security hardening following OWASP and CIS benchmarks
# - Modern TLS configuration for maximum compatibility and security
# - Comprehensive logging and monitoring capabilities
# - Rate limiting and connection management
# - Gzip compression for improved performance
# - IPv6 support throughout
# ============================================================================

# ============================================================================
# Core Configuration
# ============================================================================

# Load headers-more module for custom header manipulation
# This module allows clearing and setting custom headers like Server
# Install with: sudo apt install nginx-module-headers-more
#
# Note: Module path may vary by distribution:
# - Ubuntu/Debian: modules/ngx_http_headers_more_filter_module.so
# - CentOS/RHEL: modules/ngx_http_headers_more_filter_module.so
load_module modules/ngx_http_headers_more_filter_module.so;

# Run as www-data user for security
user www-data;

# Auto-detect optimal number of worker processes based on CPU cores
# This provides better performance than a fixed number
worker_processes auto;

# Store PID file for process management
pid /run/nginx.pid;

# Main error log - captures critical errors and warnings
# Set to 'warn' level to reduce noise while capturing important issues
error_log /var/log/nginx/error.log warn;

# Include dynamic modules (loaded from /etc/nginx/modules-enabled/)
# This allows for flexible module management without modifying this file
include /etc/nginx/modules-enabled/*.conf;

# ============================================================================
# Events Configuration
# ============================================================================

events {
    # Maximum number of simultaneous connections per worker
    # 768 is a good starting point for most servers
    # Can be increased for high-traffic sites (up to 4096 or more)
    worker_connections 768;
    
    # Enable multi_accept to allow worker processes to accept
    # multiple new connections at a time (improves performance under load)
    # multi_accept on;
    
    # Use epoll for Linux systems (most efficient event notification method)
    # This is automatically selected on Linux, but can be explicitly set
    # use epoll;
}

# ============================================================================
# HTTP Configuration
# ============================================================================

http {
    
    # ------------------------------------------------------------------------
    # Basic Performance Settings
    # ------------------------------------------------------------------------

    # Note: To customize the Server header (replace "nginx" with "NEHONIX/Xynginc"),
    # add the following in individual server blocks:
    # add_header Server "NEHONIX/Xynginc" always;
    # This requires the headers-more-nginx-module or can be done per-server basis.
    
    # Enable sendfile for efficient static file serving
    # Allows nginx to copy data between file descriptors directly
    sendfile on;
    
    # Enable TCP_NODELAY for keepalive connections
    # Improves performance by reducing latency
    tcp_nopush on;
    
    # Optimize hash tables for faster lookups
    # Larger values reduce collisions but use more memory
    types_hash_max_size 2048;
    
    # Hide nginx version in error pages and headers for security
    # Prevents information leakage about server software
    server_tokens off;
    
    # Increase server names hash bucket size for many virtual hosts
    # Prevents "could not build server_names_hash" errors
    server_names_hash_bucket_size 64;
    
    # Preserve original host header when redirecting
    # Useful for reverse proxy setups
    server_name_in_redirect off;
    
    # ------------------------------------------------------------------------
    # MIME Types and Default Content
    # ------------------------------------------------------------------------
    
    # Include standard MIME type definitions
    include /etc/nginx/mime.types;
    
    # Default content type for unknown file types
    default_type application/octet-stream;
    
    # ------------------------------------------------------------------------
    # SSL/TLS Configuration
    # ------------------------------------------------------------------------
    
    # SSL protocols - disable outdated versions for security
    # TLSv1.3 is the most secure and performant
    # TLSv1.2 is kept for broader compatibility
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # Prefer server cipher suites over client preferences
    # Ensures strongest available encryption is used
    ssl_prefer_server_ciphers on;
    
    # Modern cipher suite for strong security
    # Prioritizes forward secrecy and AES-GCM
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    
    # Enable session caching for better SSL performance
    # Shared cache among all worker processes
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;
    
    # Enable OCSP stapling for better performance
    # Reduces latency by caching certificate revocation status
    ssl_stapling on;
    ssl_stapling_verify on;
    
    # ------------------------------------------------------------------------
    # Logging Configuration
    # ------------------------------------------------------------------------
    
    # Main access log with combined format
    # Includes referrer and user agent information
    access_log /var/log/nginx/access.log combined;
    
    # Custom log format with timing information for performance monitoring
    log_format detailed '$remote_addr - $remote_user [$time_local] '
                        '"$request" $status $body_bytes_sent '
                        '"$http_referer" "$http_user_agent" '
                        'rt=$request_time uct="$upstream_connect_time" '
                        'uht="$upstream_header_time" urt="$upstream_response_time"';
    
    # ------------------------------------------------------------------------
    # Gzip Compression
    # ------------------------------------------------------------------------
    
    # Enable gzip compression for text-based content
    # Reduces bandwidth usage and improves page load times
    gzip on;
    
    # Send Vary: Accept-Encoding header to help with caching
    gzip_vary on;
    
    # Compress responses for all proxied requests
    gzip_proxied any;
    
    # Compression level (1-9), 6 is a good balance of speed vs compression
    gzip_comp_level 6;
    
    # Buffer size for compression (4x16k = 64k total)
    gzip_buffers 16 8k;
    
    # Use HTTP/1.1 for gzip to work properly
    gzip_http_version 1.1;
    
    # File types to compress
    gzip_types
        text/plain
        text/css
        application/json
        application/javascript
        text/xml
        application/xml
        application/xml+rss
        text/javascript
        application/x-font-ttf
        application/x-font-opentype
        font/woff
        font/woff2
        image/svg+xml;
    
    # ------------------------------------------------------------------------
    # Client Request Handling
    # ------------------------------------------------------------------------
    
    # Maximum body size for client requests (10MB)
    # Adjust based on your application needs
    client_max_body_size 10M;
    
    # Buffer sizes for client requests
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    
    # Large client header buffers for complex requests
    large_client_header_buffers 4 8k;
    
    # Timeout values (in seconds)
    client_body_timeout 12;
    client_header_timeout 12;
    keepalive_timeout 75;
    send_timeout 10;
    
    # ------------------------------------------------------------------------
    # Connection Limits and Rate Limiting
    # ------------------------------------------------------------------------
    
    # Rate limiting zone for request limiting
    # 10MB shared memory, 10 requests per second per IP
    limit_req_zone $binary_remote_addr zone=default_limit:10m rate=10r/s;
    
    # Connection limiting zone
    # 10MB shared memory for tracking connections
    limit_conn_zone $binary_remote_addr zone=addr:10m;
    
    # Default rate limiting (applied globally)
    # Burst allows 20 requests above the rate limit
    limit_req zone=default_limit burst=20 nodelay;
    
    # Connection limit per IP address
    limit_conn addr 10;
    
    # Custom status codes for rate limiting
    limit_req_status 429;
    limit_conn_status 429;
    
    # ------------------------------------------------------------------------
    # Proxy Settings
    # ------------------------------------------------------------------------
    
    # Proxy cache path for caching backend responses
    # Commented out by default - uncomment to enable caching
    # proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=proxy_cache:10m inactive=60m;
    # proxy_cache_key "$scheme$request_method$host$request_uri";
    
    # Default proxy settings for backend connections
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # Timeout settings for proxy connections
    proxy_connect_timeout 60;
    proxy_send_timeout 60;
    proxy_read_timeout 60;
    
    # Buffer sizes for proxy operations
    proxy_buffer_size 4k;
    proxy_buffers 8 16k;
    proxy_busy_buffers_size 24k;
    proxy_temp_file_write_size 64k;
    
    # ------------------------------------------------------------------------
    # Security Headers (Applied Globally)
    # ------------------------------------------------------------------------
    
    # Add security headers to all responses
    # These headers help protect against common web vulnerabilities
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header X-Permitted-Cross-Domain-Policies "none" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-src 'none'; object-src 'none';" always;
    
    # ------------------------------------------------------------------------
    # Virtual Host Configuration
    # ------------------------------------------------------------------------
    
    # Include virtual host configurations from sites-enabled directory
    # This is where individual site configurations are loaded
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
    
    # ------------------------------------------------------------------------
    # Additional Performance Optimizations
    # ------------------------------------------------------------------------
    
    # Enable keepalive connections for better performance
    keepalive_requests 100;
    
    # Enable TCP keepalive probes
    keepalive_disable msie6;
    
    # Optimize file serving with direct I/O
    directio 512k;
    
    # Disable symlink following for security
    disable_symlinks off;
    
    # Enable OS file cache for frequently accessed files
    open_file_cache max=1000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;
    
    # ------------------------------------------------------------------------
    # Server-Wide Error Handling
    # ------------------------------------------------------------------------
    
    # Custom error pages for common HTTP errors
    # Note: Error page location blocks must be defined in individual server blocks
    # See the default server configuration for complete error page handling. So won't define them here.
}

# ============================================================================
# Mail Proxy Configuration (Commented Out)
# ============================================================================
# Uncomment and configure if you need mail proxy functionality
# Reference: http://nginx.org/en/docs/mail/nginx_mail_proxy_module.html
#
#mail {
#    # Authentication script example
#    # auth_http localhost/auth.php;
#    
#    # POP3 proxy configuration
#    server {
#        listen     localhost:110;
#        protocol   pop3;
#        proxy      on;
#    }
#    
#    # IMAP proxy configuration
#    server {
#        listen     localhost:143;
#        protocol   imap;
#        proxy      on;
#    }
#}

# ============================================================================
# Configuration Notes
# ============================================================================
# 1. This configuration is optimized for production use with XyPriss applications
# 2. For development environments, you may want to:
#    - Increase logging verbosity
#    - Disable rate limiting
#    - Reduce security headers
# 3. Always test configuration changes with: nginx -t
# 4. Reload nginx after changes: systemctl reload nginx
# 5. Monitor logs: tail -f /var/log/nginx/error.log
# 6. For high-traffic sites, consider:
#    - Increasing worker_connections
#    - Tuning buffer sizes
#    - Implementing caching strategies
# 7. Security best practices:
#    - Regularly update nginx
#    - Monitor for vulnerabilities
#    - Review access logs for suspicious activity
